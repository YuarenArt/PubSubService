# PubSubService

PubSubService — это сервис, построенный на технологии gRPC, который реализует систему "издатель-подписчик" (Publisher-Subscriber). Он позволяет пользователям:

- Подписываться на определённые ключи (темы) и получать сообщения, связанные с этими ключами.
- Публиковать сообщения по ключам, которые будут доставлены всем подписчикам.
- Отписываться от ключей или завершать работу.

Сервис состоит из двух основных частей:

- **Сервер**: gRPC-сервер, который управляет подписками и доставкой сообщений.
- **Клиент**: Инструмент командной строки для взаимодействия с сервером через команды `subscribe`, `unsubscribe`, `publish` и `exit`.

## Как это работает

### Сервер:
- Слушает подключения на настраиваемом адресе (по умолчанию: `localhost:50051`).
- Хранит подписки и сообщения в памяти с помощью внутренней системы subpub.
- Доставляет сообщения подписчикам в реальном времени.

### Клиент:
- Подключается к серверу через gRPC.
- Позволяет вводить команды для подписки, публикации сообщений или отписки.
- Выводит полученные сообщения в консоль.

Система поддерживает одновременную работу нескольких подписчиков на один ключ и асинхронную доставку сообщений.

## Требования для сборки и запуска

- Docker и Docker Compose для запуска в контейнерах.
- Go 1.24 для локальной сборки и разработки.
- Make для выполнения команд сборки через Makefile.
- protoc и плагины Go для генерации gRPC-кода.

## Быстрый старт

1. Генерация Protobuf
   ```bash
   make proto
   ```
2. Сборка бинарников
   ```bash
   make build
   ```
3. Запуск локально
   ```bash
   make run-server # запускает сервер
   make run-client # запускает клиента
   ```
4. Docker / Docker Compose
   ```bash
   make docker-build # сборка образов
   make docker-up # запуск сервисов
   make docker-down # остановка и удаление контейнеров
   ```

## Настройка сервиса

Сервис можно настроить с помощью переменных окружения или флагов командной строки. Основные параметры:

| Название            | Что настраивает               | Значение по умолчанию |
|----------------------|--------------------------------|-----------------------|
| GRPC_ADDRESS         | Адрес и порт сервера          | localhost:50051       |
| LOG_TYPE             | Тип логгера                    | slog                  |
| LOG_FILE             | Путь к файлу логов             | logs/pubsub.log       |
| LOG_TO_CONSOLE       | Логи в консоль (true/false)    | true, 1, Y            |
| LOG_TO_FILE          | Логи в файл (true/false)       | true, 1, Y                |

Изменить настройки можно в файле `docker-compose.yml` или задав переменные окружения.

## Используемые паттерны проектирования

- **Observer (Publisher/Subscriber)** — основа архитектуры. Слушатели подписываются на события, публикуемые по ключу.
- **Functional Options** — конфигурация шины событий через настраиваемые опции (WithBufferSize(), WithTimeout() и т.д.).
- **Dependency Injection** — передача зависимостей через интерфейсы (например, логгер, шина), повышающая модульность и удобство тестирования.
- **Context Propagation** — отмена операций при завершении контекста, обработка таймаутов, корректное завершение работы горутин.
- **Middleware / Interceptor** — обвязки вокруг gRPC-методов для централизованной обработки логирования, метрик, ошибок.
- **Graceful Shutdown** — корректное завершение всех горутин и потоков при остановке сервиса через context.Context и sync.WaitGroup.
